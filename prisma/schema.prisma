// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum TipoDocumento {
  DNI                // Documento Nacional de Identidad (Perú)
  CARNET_EXTRANJERIA // Carnet de Extranjería
  PASAPORTE          // Pasaporte
  OTRO               // Otro tipo de documento

  @@map("tipo_documento")
}

enum AuditStatus {
  SUCCESS
  FAILURE
  PENDING

  @@map("audit_status")
}

// ============================================
// USUARIOS Y AUTENTICACION
// ============================================

/// Tabla principal de usuarios del sistema
model User {
  id               String    @id @default(cuid())

  // Documento de identidad
  tipoDocumento    TipoDocumento @default(DNI) @map("tipo_documento")
  numeroDocumento  String    @unique @map("numero_documento") @db.VarChar(20)

  username         String?   @unique @db.VarChar(50)
  email            String    @unique
  emailPersonal    String?   @map("email_personal")
  passwordHash     String    @map("password_hash")

  // Datos personales
  nombres          String    @db.VarChar(100)
  apellidoPaterno  String    @map("apellido_paterno") @db.VarChar(100)
  apellidoMaterno  String    @map("apellido_materno") @db.VarChar(100)
  avatarUrl        String?   @map("avatar_url") @db.VarChar(255)
  telefono         String?   @db.VarChar(20)

  // Verificacion y estado
  isActive        Boolean   @default(true) @map("is_active")
  isVerified      Boolean   @default(false) @map("is_verified")
  emailVerifiedAt DateTime? @map("email_verified_at")
  lastLoginAt     DateTime? @map("last_login_at")
  lastLoginIp     String?   @map("last_login_ip") @db.VarChar(45)
  failedLoginAttempts Int   @default(0) @map("failed_login_attempts")
  lockedUntil     DateTime? @map("locked_until")

  // Cache de datos de API externa
  externalDataCache   Json?     @map("external_data_cache")
  externalDataSyncAt  DateTime? @map("external_data_sync_at")

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relaciones
  roles           UserRole[]
  sessions        Session[]
  refreshTokens   RefreshToken[]
  studentCareers  StudentCareer[]
  teacherInfo     TeacherInfo?
  auditLogs          AuditLog[]
  passwordResets     PasswordReset[]
  emailVerifications EmailVerification[]

  // Relaciones con tesis
  tesisComoAutor        ThesisAuthor[]
  tesisComoAsesor       ThesisAdvisor[]
  tesisComoJurado       ThesisJury[]
  documentosSubidos     ThesisDocument[]
  cambiosEstadoTesis    ThesisStatusHistory[]

  @@index([email])
  @@index([numeroDocumento])
  @@index([tipoDocumento, numeroDocumento])
  @@index([isActive, isVerified])
  @@map("users")
}

/// Carreras de estudiantes (un estudiante puede tener multiples carreras)
model StudentCareer {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")

  // Datos de la carrera
  codigoEstudiante  String   @map("codigo_estudiante") @db.VarChar(20)
  carreraNombre     String   @map("carrera_nombre") @db.VarChar(150)
  facultadId        String   @map("facultad_id")
  creditosAprobados Decimal? @map("creditos_aprobados") @db.Decimal(10, 2)

  // Estado
  isActive          Boolean  @default(true) @map("is_active")

  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relaciones
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  facultad          Faculty  @relation(fields: [facultadId], references: [id])
  tesisAutor        ThesisAuthor[]

  @@unique([userId, codigoEstudiante])
  @@index([userId])
  @@index([facultadId])
  @@map("student_careers")
}

/// Información de docentes
model TeacherInfo {
  id                    String   @id @default(cuid())
  userId                String   @unique @map("user_id")

  // Datos del docente
  codigoDocente         String   @map("codigo_docente") @db.VarChar(20)
  departamentoAcademico String   @map("departamento_academico") @db.VarChar(150)
  facultadId            String   @map("facultad_id")

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relaciones
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  facultad              Faculty  @relation(fields: [facultadId], references: [id])

  @@index([facultadId])
  @@map("teacher_info")
}

// ============================================
// ESTRUCTURA ACADEMICA
// ============================================

/// Facultades de la universidad
model Faculty {
  id        String   @id @default(cuid())
  nombre    String   @unique @db.VarChar(150)
  codigo    String   @unique @db.VarChar(20)

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  schools         School[]
  studentCareers  StudentCareer[]
  teacherInfo     TeacherInfo[]

  @@map("faculties")
}

/// Escuelas profesionales
model School {
  id         String   @id @default(cuid())
  facultadId String   @map("facultad_id")
  nombre     String   @db.VarChar(150)
  codigo     String   @unique @db.VarChar(20)

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  facultad  Faculty  @relation(fields: [facultadId], references: [id])

  @@index([facultadId])
  @@map("schools")
}

// ============================================
// SISTEMA DE ROLES Y PERMISOS
// ============================================

/// Módulos del sistema (para organizar permisos)
model SystemModule {
  id          String   @id @default(cuid())
  nombre      String   @unique @db.VarChar(100)
  codigo      String   @unique @db.VarChar(50)
  descripcion String?
  icono       String?  @db.VarChar(50)
  ruta        String?  @db.VarChar(200)
  orden       Int      @default(0)
  isActive    Boolean  @default(true) @map("is_active")

  // Módulo padre (para jerarquía)
  parentId    String?  @map("parent_id")
  parent      SystemModule?  @relation("ModuleHierarchy", fields: [parentId], references: [id])
  children    SystemModule[] @relation("ModuleHierarchy")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relaciones
  permissions RolePermission[]

  @@index([parentId])
  @@map("system_modules")
}

/// Roles del sistema
model Role {
  id          String   @id @default(cuid())
  nombre      String   @unique @db.VarChar(100)
  codigo      String   @unique @db.VarChar(50)
  descripcion String?
  color       String?  @db.VarChar(20)
  isSystem    Boolean  @default(false) @map("is_system")
  isActive    Boolean  @default(true) @map("is_active")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relaciones
  users       UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

/// Permisos por rol y módulo
model RolePermission {
  id          String   @id @default(cuid())
  roleId      String   @map("role_id")
  moduleId    String   @map("module_id")

  // Permisos CRUD
  canView     Boolean  @default(false) @map("can_view")
  canCreate   Boolean  @default(false) @map("can_create")
  canEdit     Boolean  @default(false) @map("can_edit")
  canDelete   Boolean  @default(false) @map("can_delete")

  // Permisos personalizados adicionales
  customPermissions Json? @map("custom_permissions")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relaciones
  role        Role         @relation(fields: [roleId], references: [id], onDelete: Cascade)
  module      SystemModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([roleId, moduleId])
  @@index([roleId])
  @@index([moduleId])
  @@map("role_permissions")
}

/// Asignación de roles a usuarios (con contexto opcional)
model UserRole {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  roleId      String    @map("role_id")

  // Contexto del rol (ej: rol de asesor en una facultad específica)
  contextType String?   @map("context_type") @db.VarChar(50)
  contextId   String?   @map("context_id")

  // Metadata
  assignedAt  DateTime  @default(now()) @map("assigned_at")
  expiresAt   DateTime? @map("expires_at")
  assignedBy  String?   @map("assigned_by")
  isActive    Boolean   @default(true) @map("is_active")

  // Relaciones
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, contextType, contextId])
  @@index([userId])
  @@index([roleId])
  @@index([contextType, contextId])
  @@map("user_roles")
}

// ============================================
// SESIONES Y TOKENS
// ============================================

/// Sesiones de usuario
model Session {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  ipAddress    String?   @map("ip_address") @db.VarChar(45)
  userAgent    String?   @map("user_agent")
  deviceInfo   Json?     @map("device_info")

  createdAt    DateTime  @default(now()) @map("created_at")
  expiresAt    DateTime  @map("expires_at")
  lastActiveAt DateTime  @default(now()) @map("last_active_at")

  // Relaciones
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

/// Refresh tokens para JWT
model RefreshToken {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  token         String    @unique @db.VarChar(500)
  tokenHash     String    @unique @map("token_hash") @db.VarChar(64)
  deviceId      String?   @map("device_id") @db.VarChar(100)
  ipAddress     String?   @map("ip_address") @db.VarChar(45)
  userAgent     String?   @map("user_agent")

  isRevoked     Boolean   @default(false) @map("is_revoked")
  revokedAt     DateTime? @map("revoked_at")
  revokedReason String?   @map("revoked_reason") @db.VarChar(100)

  createdAt     DateTime  @default(now()) @map("created_at")
  expiresAt     DateTime  @map("expires_at")
  lastUsedAt    DateTime? @map("last_used_at")

  // Relaciones
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

/// Tokens de restablecimiento de contraseña
model PasswordReset {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  token      String    @unique @db.VarChar(100)
  tokenHash  String    @unique @map("token_hash") @db.VarChar(64)
  isUsed     Boolean   @default(false) @map("is_used")
  usedAt     DateTime? @map("used_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  expiresAt  DateTime  @map("expires_at")

  // Relaciones
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("password_resets")
}

/// Tokens de verificación de email
model EmailVerification {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  email     String    @db.VarChar(255)
  token     String    @unique @db.VarChar(100)
  tokenHash String    @unique @map("token_hash") @db.VarChar(64)
  isUsed    Boolean   @default(false) @map("is_used")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime  @map("expires_at")

  // Relaciones
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("email_verifications")
}

// ============================================
// AUDITORÍA Y LOGS
// ============================================

/// Registro de auditoría
model AuditLog {
  id            String      @id @default(cuid())
  userId        String?     @map("user_id")
  action        String      @db.VarChar(100)
  entityType    String?     @map("entity_type") @db.VarChar(100)
  entityId      String?     @map("entity_id")
  description   String?
  oldValues     Json?       @map("old_values")
  newValues     Json?       @map("new_values")
  metadata      Json?
  ipAddress     String?     @map("ip_address") @db.VarChar(45)
  userAgent     String?     @map("user_agent")
  requestPath   String?     @map("request_path") @db.VarChar(500)
  requestMethod String?     @map("request_method") @db.VarChar(10)
  status        AuditStatus @default(SUCCESS)
  errorMessage  String?     @map("error_message")
  createdAt     DateTime    @default(now()) @map("created_at")

  // Relaciones
  user          User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

/// Rate limiting
model RateLimit {
  id            String   @id @default(cuid())
  identifier    String   @db.VarChar(255)
  endpoint      String   @db.VarChar(255)
  requestCount  Int      @default(1) @map("request_count")
  windowStart   DateTime @map("window_start")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([identifier, endpoint, windowStart])
  @@index([identifier, endpoint])
  @@index([windowStart])
  @@map("rate_limits")
}

// ============================================
// TESIS - MODELOS PRINCIPALES
// ============================================

enum EstadoTesis {
  BORRADOR                // Recién creada, sin enviar
  EN_REVISION             // Enviada para revisión
  OBSERVADA               // Tiene observaciones pendientes
  ASIGNANDO_JURADOS       // Mesa de partes asigna jurados evaluadores
  EN_EVALUACION_JURADO    // Jurados evaluando el proyecto (15 días)
  OBSERVADA_JURADO        // Jurado observó, estudiante corrige (30 días)
  PROYECTO_APROBADO       // Jurado aprobó el proyecto
  INFORME_FINAL           // Estudiante sube informe final
  EN_EVALUACION_INFORME   // Jurados evaluando el informe final
  OBSERVADA_INFORME       // Jurado observó informe, estudiante corrige
  APROBADA                // Aprobada por el comité
  EN_SUSTENTACION         // En proceso de sustentación
  SUSTENTADA              // Ya sustentada
  ARCHIVADA               // Archivada (histórico)
  RECHAZADA               // Rechazada definitivamente

  @@map("estado_tesis")
}

enum TipoJurado {
  PRESIDENTE
  VOCAL
  SECRETARIO
  ACCESITARIO

  @@map("tipo_jurado")
}

enum ResultadoEvaluacion {
  APROBADO
  OBSERVADO

  @@map("resultado_evaluacion")
}

enum FaseEvaluacion {
  PROYECTO
  INFORME_FINAL

  @@map("fase_evaluacion")
}

enum TipoAsesor {
  PRINCIPAL
  CO_ASESOR

  @@map("tipo_asesor")
}

enum EstadoAsesor {
  PENDIENTE           // Esperando respuesta
  ACEPTADO            // Aceptó ser asesor
  RECHAZADO           // Rechazó ser asesor

  @@map("estado_asesor")
}

enum EstadoAutor {
  PENDIENTE           // Esperando respuesta (para coautores)
  ACEPTADO            // Aceptó participar
  RECHAZADO           // Rechazó participar

  @@map("estado_autor")
}

enum TipoDocumentoTesis {
  PROYECTO                    // Proyecto de tesis
  BORRADOR                    // Borrador del documento
  DOCUMENTO_FINAL             // Documento final
  ACTA_SUSTENTACION           // Acta de sustentación
  CERTIFICADO                 // Certificados varios
  ANEXO                       // Documentos anexos
  CARTA_ACEPTACION_ASESOR     // Carta de aceptación del asesor
  CARTA_ACEPTACION_COASESOR   // Carta de aceptación del coasesor
  VOUCHER_PAGO                // Voucher de pago (S/. 30 - código 277)
  DOCUMENTO_SUSTENTATORIO     // Documento sustentatorio (matrícula, SUNEDU o egresado)
  DICTAMEN_JURADO             // Dictamen firmado por el jurado
  RESOLUCION_APROBACION       // Resolución de aprobación subida por mesa de partes
  REPORTE_TURNITIN            // Reporte de similitud Turnitin
  INFORME_FINAL_DOC           // Documento de informe final
  VOUCHER_PAGO_INFORME        // Voucher de pago informe final (S/. 20 - código 465)
  ACTA_VERIFICACION_ASESOR    // Acta de verificación de similitud del asesor
  OTRO

  @@map("tipo_documento_tesis")
}

/// Tesis
model Thesis {
  id              String      @id @default(cuid())
  titulo          String      @db.VarChar(500)
  resumen         String?     @db.Text
  palabrasClave   String[]    @map("palabras_clave")

  // Estado actual
  estado          EstadoTesis @default(BORRADOR)

  // Fechas importantes
  fechaInicio     DateTime?   @map("fecha_inicio")
  fechaAprobacion DateTime?   @map("fecha_aprobacion")
  fechaSustentacion DateTime? @map("fecha_sustentacion")

  // Metadata
  lineaInvestigacion String?  @map("linea_investigacion") @db.VarChar(200)
  areaConocimiento   String?  @map("area_conocimiento") @db.VarChar(200)

  // Confirmación de voucher físico por mesa de partes
  voucherFisicoEntregado    Boolean   @default(false) @map("voucher_fisico_entregado")
  voucherFisicoFecha        DateTime? @map("voucher_fisico_fecha")

  // Confirmación de voucher físico informe final por mesa de partes
  voucherInformeFisicoEntregado Boolean   @default(false) @map("voucher_informe_fisico_entregado")
  voucherInformeFisicoFecha     DateTime? @map("voucher_informe_fisico_fecha")

  // Evaluación por jurados
  rondaActual              Int       @default(0) @map("ronda_actual")
  faseActual               String?   @map("fase_actual") @db.VarChar(20)
  fechaLimiteEvaluacion    DateTime? @map("fecha_limite_evaluacion")
  fechaLimiteCorreccion    DateTime? @map("fecha_limite_correccion")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  deletedAt       DateTime?   @map("deleted_at")

  // Relaciones
  autores              ThesisAuthor[]
  asesores             ThesisAdvisor[]
  documentos           ThesisDocument[]
  historialEstados     ThesisStatusHistory[]
  jurados              ThesisJury[]
  evaluacionesJurado   JuryEvaluation[]

  @@index([estado])
  @@index([createdAt])
  @@map("thesis")
}

/// Autores de tesis (estudiantes)
model ThesisAuthor {
  id              String      @id @default(cuid())
  thesisId        String      @map("thesis_id")
  userId          String      @map("user_id")
  studentCareerId String      @map("student_career_id")

  // Orden de autoría
  orden           Int         @default(1)

  // Estado de participación (para coautores)
  estado          EstadoAutor @default(ACEPTADO)
  fechaRespuesta  DateTime?   @map("fecha_respuesta")
  motivoRechazo   String?     @map("motivo_rechazo")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relaciones
  thesis          Thesis      @relation(fields: [thesisId], references: [id], onDelete: Cascade)
  user            User        @relation(fields: [userId], references: [id])
  studentCareer   StudentCareer @relation(fields: [studentCareerId], references: [id])

  @@unique([thesisId, userId])
  @@index([thesisId])
  @@index([userId])
  @@map("thesis_authors")
}

/// Asesores de tesis
model ThesisAdvisor {
  id              String       @id @default(cuid())
  thesisId        String       @map("thesis_id")
  userId          String       @map("user_id")
  tipo            TipoAsesor   @default(PRINCIPAL)

  // Estado de aceptación
  estado          EstadoAsesor @default(PENDIENTE)
  fechaRespuesta  DateTime?    @map("fecha_respuesta")

  // Timestamps
  createdAt       DateTime     @default(now()) @map("created_at")

  // Relaciones
  thesis          Thesis       @relation(fields: [thesisId], references: [id], onDelete: Cascade)
  user            User         @relation(fields: [userId], references: [id])

  @@unique([thesisId, userId])
  @@index([thesisId])
  @@index([userId])
  @@map("thesis_advisors")
}

/// Documentos de tesis
model ThesisDocument {
  id              String              @id @default(cuid())
  thesisId        String              @map("thesis_id")
  uploadedById    String              @map("uploaded_by_id")

  tipo            TipoDocumentoTesis
  nombre          String              @db.VarChar(255)
  descripcion     String?
  rutaArchivo     String              @map("ruta_archivo") @db.VarChar(500)
  mimeType        String?             @map("mime_type") @db.VarChar(100)
  tamano          Int?                // en bytes
  version         Int                 @default(1)
  esVersionActual Boolean             @default(true) @map("es_version_actual")

  // Firma digital
  firmadoDigitalmente Boolean         @default(false) @map("firmado_digitalmente")
  fechaFirma      DateTime?           @map("fecha_firma")
  hashDocumento   String?             @map("hash_documento") @db.VarChar(128)

  // Timestamps
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // Relaciones
  thesis          Thesis              @relation(fields: [thesisId], references: [id], onDelete: Cascade)
  uploadedBy      User                @relation(fields: [uploadedById], references: [id])

  @@index([thesisId])
  @@index([tipo])
  @@map("thesis_documents")
}

/// Historial de estados de tesis
model ThesisStatusHistory {
  id              String      @id @default(cuid())
  thesisId        String      @map("thesis_id")
  changedById     String      @map("changed_by_id")

  estadoAnterior  EstadoTesis? @map("estado_anterior")
  estadoNuevo     EstadoTesis  @map("estado_nuevo")
  comentario      String?

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relaciones
  thesis          Thesis      @relation(fields: [thesisId], references: [id], onDelete: Cascade)
  changedBy       User        @relation(fields: [changedById], references: [id])

  @@index([thesisId])
  @@index([createdAt])
  @@map("thesis_status_history")
}

// ============================================
// JURADOS Y EVALUACIONES
// ============================================

/// Jurados asignados a una tesis
model ThesisJury {
  id          String         @id @default(cuid())
  thesisId    String         @map("thesis_id")
  userId      String         @map("user_id")
  tipo        TipoJurado
  fase        FaseEvaluacion @default(PROYECTO)
  isActive    Boolean        @default(true) @map("is_active")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  thesis       Thesis          @relation(fields: [thesisId], references: [id], onDelete: Cascade)
  user         User            @relation(fields: [userId], references: [id])
  evaluaciones JuryEvaluation[]

  @@unique([thesisId, userId, fase])
  @@index([thesisId])
  @@index([userId])
  @@map("thesis_jury")
}

/// Evaluaciones individuales de jurados
model JuryEvaluation {
  id             String              @id @default(cuid())
  thesisId       String              @map("thesis_id")
  juryMemberId   String              @map("jury_member_id")
  ronda          Int                 @default(1)
  resultado      ResultadoEvaluacion
  observaciones  String?             @db.Text
  archivoUrl     String?             @map("archivo_url") @db.VarChar(500)
  createdAt      DateTime            @default(now()) @map("created_at")

  thesis     Thesis     @relation(fields: [thesisId], references: [id], onDelete: Cascade)
  juryMember ThesisJury @relation(fields: [juryMemberId], references: [id], onDelete: Cascade)

  @@unique([juryMemberId, ronda])
  @@index([thesisId])
  @@index([juryMemberId])
  @@map("jury_evaluations")
}
